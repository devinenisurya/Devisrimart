<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DEVI SRI MART | Enterprise POS</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;900&family=Ramabhadra&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; overflow: hidden; height: 100vh; background-color: #f8fafc; }
        .telugu { font-family: 'Ramabhadra', sans-serif; }
        .brand-orange { color: #ea580c !important; }
        .active-tab { background: #0f172a !important; color: white !important; }
        .report-active { background: #ea580c !important; color: white !important; border-color: #ea580c !important; }
        
        @media print { 
            .no-print { display: none !important; } 
            .print-only { display: block !important; } 
            body { background: white; overflow: visible; height: auto; }
            .receipt-container { width: 80mm; padding: 5mm; font-family: monospace; font-size: 11px; color: #000; }
            .print-brand { color: #ea580c !important; font-weight: 900 !important; font-size: 24px !important; -webkit-print-color-adjust: exact; }
        }
        
        .print-only { display: none; }
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .sidebar-item { border-left: 4px solid transparent; transition: 0.2s; cursor: pointer; color: #64748b; font-weight: 600; }
        .sidebar-item:hover { background: #f1f5f9; border-left-color: #ea580c; color: #0f172a; }
        .modal-header { position: sticky; top: 0; background: white; z-index: 100; border-bottom: 2px solid #f1f5f9; padding-bottom: 1rem; margin-bottom: 1rem; }
    </style>
</head>
<body class="text-slate-900">

    <div id="loginOverlay" class="fixed inset-0 bg-slate-900/90 z-[500] flex items-center justify-center hidden no-print backdrop-blur-sm">
        <div class="bg-white p-10 rounded-3xl shadow-2xl max-w-sm w-full text-center border-t-8 border-orange-600">
            <h2 class="text-xl font-black mb-4 uppercase">Admin Security</h2>
            <input type="password" id="adminPassInput" placeholder="Password (123)" class="w-full p-4 border-2 rounded-xl mb-4 text-center text-2xl font-black outline-none bg-slate-50">
            <button onclick="checkPassword()" class="w-full bg-slate-900 text-white py-4 rounded-xl font-bold uppercase hover:bg-black transition">Unlock</button>
            <button onclick="closeLogin()" class="mt-4 text-slate-400 text-xs uppercase underline">Cancel</button>
        </div>
    </div>

    <div id="miscModal" class="fixed inset-0 bg-slate-900/60 z-[450] hidden flex items-center justify-center no-print backdrop-blur-sm">
        <div class="bg-white p-8 rounded-[40px] shadow-2xl w-[420px] border">
            <h2 class="text-xl font-black uppercase mb-6 italic text-orange-600">Add Unlisted Item üïâÔ∏è</h2>
            <div class="space-y-4">
                <input type="text" id="m_name" placeholder="Item Name" class="w-full border-2 p-4 rounded-xl font-bold outline-none italic bg-slate-50">
                <div class="grid grid-cols-2 gap-3">
                    <input type="number" id="m_price" placeholder="Price (‚Çπ)" class="border-2 p-4 rounded-xl font-black text-orange-600">
                    <input type="number" id="m_qty" placeholder="Qty" value="1" class="border-2 p-4 rounded-xl font-black">
                </div>
                <div class="grid grid-cols-2 gap-3 text-xs font-bold text-slate-400 uppercase italic">
                    <div><label>CGST %</label><input type="number" id="m_cgst" value="9" class="w-full border p-3 rounded-xl text-slate-900 outline-none"></div>
                    <div><label>SGST %</label><input type="number" id="m_sgst" value="9" class="w-full border p-3 rounded-xl text-slate-900 outline-none"></div>
                </div>
                <button onclick="addMiscToCart()" class="w-full bg-orange-600 text-white py-5 rounded-2xl font-black uppercase shadow-xl mt-2 italic">Add to Bill</button>
                <button onclick="closeMiscTool()" class="w-full text-slate-400 font-bold text-xs uppercase mt-2 italic">Cancel</button>
            </div>
        </div>
    </div>

    <div class="flex h-full w-full">
        <aside class="w-72 bg-white border-r border-slate-100 flex flex-col no-print shadow-sm relative z-50">
            <div class="p-8">
                <h1 class="text-2xl font-black uppercase tracking-tighter brand-orange italic">Devi Sri Mart üïâÔ∏è</h1>
                <p class="text-[10px] font-bold text-slate-400 uppercase tracking-[0.3em] mb-10 italic">Hardware & Paints</p>
                <nav class="space-y-1">
                    <p class="text-[10px] font-bold text-slate-300 uppercase mb-4 px-4 tracking-widest italic">Inventory Groups</p>
                    <button onclick="filterCategory('All')" id="tab-All" class="sidebar-item w-full text-left px-5 py-4 rounded-xl font-bold text-xs active-tab uppercase">üìÇ All Stock</button>
                    <button onclick="filterCategory('Motors')" id="tab-Motors" class="sidebar-item w-full text-left px-5 py-4 rounded-xl font-bold text-xs uppercase italic">‚öôÔ∏è Motors</button>
                    <button onclick="filterCategory('Paints')" id="tab-Paints" class="sidebar-item w-full text-left px-5 py-4 rounded-xl font-bold text-xs uppercase italic">üé® Paints</button>
                    <button onclick="filterCategory('Electrical')" id="tab-Electrical" class="sidebar-item w-full text-left px-5 py-4 rounded-xl font-bold text-xs uppercase italic">‚ö° Electrical</button>
                    <button onclick="filterCategory('Sanitary')" id="tab-Sanitary" class="sidebar-item w-full text-left px-5 py-4 rounded-xl font-bold text-xs uppercase italic">üöΩ Sanitary</button>
                    <button onclick="filterCategory('Hardware')" id="tab-Hardware" class="sidebar-item w-full text-left px-5 py-4 rounded-xl font-bold text-xs uppercase italic">üõ† Hardware</button>
                </nav>
            </div>
            <div class="mt-auto p-4 space-y-2 border-t bg-slate-50">
                <button onclick="openSecureArea('reports')" class="w-full bg-white border text-blue-700 p-3 rounded-xl font-bold text-[10px] uppercase flex justify-between shadow-sm">üìä Reports<span>‚Üí</span></button>
                <button onclick="openSecureArea('inventory')" class="w-full bg-white border text-green-700 p-3 rounded-xl font-bold text-[10px] uppercase flex justify-between shadow-sm">üì¶ Inventory<span>‚Üí</span></button>
            </div>
        </aside>

        <main class="flex-1 flex flex-col overflow-hidden no-print">
            <header class="h-20 bg-white border-b border-slate-100 px-10 flex items-center justify-between shadow-sm">
                <input type="text" id="barcodeScanner" oninput="liveSearch()" placeholder="üîç Type product name..." class="w-full max-w-xl bg-slate-50 p-3 rounded-xl outline-none font-medium border border-slate-100 focus:bg-white focus:border-orange-500 transition-all">
                <button onclick="openMiscTool()" class="bg-orange-600 text-white px-5 py-2 rounded-xl font-black text-xs uppercase shadow-lg hover:bg-orange-700 transition">+ Add Unlisted</button>
            </header>
            <div id="productGrid" class="flex-1 overflow-y-auto p-8 grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 2xl:grid-cols-5 gap-4 no-scrollbar"></div>
        </main>

        <aside class="w-[450px] bg-white border-l border-slate-100 flex flex-col no-print h-full shadow-2xl relative z-50">
            <div class="p-6 border-b bg-slate-900 text-white flex justify-between items-center">
                <h3 class="font-black text-xs uppercase tracking-widest text-orange-500 italic underline underline-offset-4">Sales Cart</h3>
                <button onclick="clearCart()" class="text-[10px] font-bold border border-white/20 px-3 py-1 rounded hover:bg-red-500 uppercase italic">Clear</button>
            </div>
            <div id="cartItems" class="flex-1 overflow-y-auto p-4 space-y-4 bg-slate-50/50 no-scrollbar"></div>
            <div class="p-8 bg-white border-t border-slate-100 space-y-4">
                <div class="grid grid-cols-2 gap-4 text-[11px] font-black uppercase text-orange-600 italic">
                    <div class="flex justify-between"><span>CGST Amount</span><span id="cgstDisplay">‚Çπ0.00</span></div>
                    <div class="flex justify-between"><span>SGST Amount</span><span id="sgstDisplay">‚Çπ0.00</span></div>
                </div>
                <div class="pt-4 border-t-2 border-double border-slate-100 flex justify-between items-end">
                    <span class="text-xs font-black text-slate-400 uppercase italic leading-none">Grand Total Bill</span>
                    <span id="grandTotal" class="text-5xl font-black text-slate-900 tracking-tighter italic">‚Çπ0</span>
                </div>
                <button onclick="goToPayment()" class="w-full bg-slate-900 text-white py-6 rounded-3xl font-black text-lg uppercase tracking-widest shadow-2xl transition hover:bg-orange-600">Proceed to Payment</button>
            </div>
        </aside>
    </div>

    <div id="paymentPage" class="hidden fixed inset-0 z-[100] bg-slate-900/70 backdrop-blur-sm no-print flex items-center justify-center p-2">
        <div class="max-w-6xl w-full bg-white rounded-[40px] shadow-2xl flex border-8 border-white overflow-hidden h-[500px]">
            <div class="w-80 bg-slate-900 p-8 text-white flex flex-col border-r border-slate-800">
                <button onclick="backToSales()" class="text-slate-500 font-bold text-[10px] uppercase mb-10 hover:text-white transition italic font-black underline">‚Üê Edit Cart</button>
                <h2 class="text-sm font-bold border-b border-slate-800 pb-3 mb-6 uppercase text-orange-500 tracking-widest italic font-black">Invoice Summary</h2>
                <div id="paymentSummaryList" class="flex-1 overflow-y-auto text-[10px] opacity-40 italic space-y-2"></div>
                <p id="paymentTotalDisplay" class="text-5xl font-black text-white italic tracking-tighter mt-4 leading-none">‚Çπ0.00</p>
            </div>
            
            <div class="w-[380px] p-8 flex flex-col bg-slate-50 border-r border-slate-200">
                <h3 class="font-bold text-xs mb-6 uppercase text-slate-400 italic tracking-widest">1. Payment Mode</h3>
                <div class="grid grid-cols-2 gap-3 mb-8">
                    <button onclick="setMode('Cash')" id="mCash" class="pay-btn border-4 p-5 rounded-2xl font-black text-[10px] report-active uppercase">üíµ Cash</button>
                    <button onclick="setMode('UPI')" id="mUPI" class="pay-btn border-2 border-slate-200 p-5 rounded-2xl font-black text-[10px] bg-white italic uppercase">üì± UPI</button>
                    <button onclick="setMode('Card')" id="mCard" class="pay-btn border-2 border-slate-200 p-5 rounded-2xl font-black text-[10px] bg-white italic uppercase">üí≥ Card</button>
                    <button onclick="setMode('Khaata')" id="mKhaata" class="pay-btn border-2 border-slate-200 p-5 rounded-2xl font-black text-[10px] bg-white italic uppercase">üìî Khaata</button>
                </div>
                <div id="cashSuggestions" class="grid grid-cols-2 gap-2 mt-auto"></div>
            </div>

            <div class="flex-1 p-8 flex flex-col bg-white">
                <h3 class="font-bold text-xs mb-6 uppercase text-slate-400 italic text-center tracking-widest">2. Change Calculator</h3>
                <div class="flex flex-col gap-4">
                    <div class="relative">
                        <input type="number" id="cashReceived" placeholder="Recvd" class="w-full p-6 bg-slate-50 border-2 rounded-2xl text-5xl font-black text-center outline-none focus:border-blue-600 transition-all">
                        <button onclick="updateChange()" class="absolute right-3 top-3 bottom-3 bg-blue-600 text-white px-5 rounded-xl font-bold uppercase text-xs shadow-lg hover:bg-blue-800 transition">Enter</button>
                    </div>
                    <div class="bg-slate-900 text-white p-6 rounded-[35px] shadow-2xl text-center">
                        <span class="text-[10px] font-bold opacity-40 uppercase tracking-widest block mb-1 italic">Balance to return</span>
                        <span id="paymentChangeDisplay" class="text-6xl font-black text-green-400 italic tracking-tighter leading-none">‚Çπ0</span>
                    </div>
                </div>
                <button onclick="finalizeSale()" class="w-full bg-orange-600 text-white py-6 rounded-[30px] mt-auto font-black text-2xl shadow-xl uppercase italic tracking-widest shadow-orange-100 hover:scale-105 transition-all">Print Receipt üïâÔ∏è</button>
            </div>
        </div>
    </div>

    <div id="inventoryPage" class="fixed inset-0 bg-white z-[300] hidden no-print p-10 overflow-y-auto">
        <div class="max-w-6xl mx-auto">
            <div class="modal-header flex justify-between items-center">
                <h2 class="text-3xl font-black uppercase italic brand-orange tracking-tighter">Stock Ledger üïâÔ∏è</h2>
                <button onclick="toggleModal('inventoryPage')" class="bg-slate-900 text-white px-10 py-3 rounded-full font-black text-xs uppercase shadow-xl hover:bg-orange-600 transition">‚Üê Back to Sales</button>
            </div>
            <table class="w-full text-left border-collapse bg-white rounded-3xl overflow-hidden shadow-2xl border">
                <thead class="bg-slate-900 text-white uppercase text-[10px] font-black italic tracking-widest">
                    <tr><th class="p-6">Description</th><th class="p-6 text-center">Stock</th><th class="p-6 text-center">Rate</th><th class="p-6 text-center">CGST</th><th class="p-6 text-center">SGST</th><th class="p-6 text-center">Action</th></tr>
                </thead>
                <tbody id="inventoryTableBody" class="font-bold text-xs uppercase italic"></tbody>
            </table>
        </div>
    </div>

    <div id="reportsModal" class="fixed inset-0 bg-white z-[300] hidden no-print p-10 overflow-y-auto animate-slide">
        <div class="max-w-6xl mx-auto">
            <div class="modal-header flex justify-between items-center italic">
                <h2 class="text-3xl font-black uppercase brand-orange tracking-tighter">Performance üïâÔ∏è</h2>
                <button onclick="toggleModal('reportsModal')" class="bg-slate-900 text-white px-10 py-3 rounded-full font-black text-xs uppercase shadow-xl">‚Üê Back to Sales</button>
            </div>
            <div class="flex gap-4 mb-10 italic">
                <button id="btnDay" onclick="renderAnalytics('day')" class="px-10 py-4 rounded-2xl font-black text-xs border-2 uppercase bg-white transition-all">Today</button>
                <button id="btnWeek" onclick="renderAnalytics('week')" class="px-10 py-4 rounded-2xl font-black text-xs border-2 uppercase bg-white transition-all">Weekly</button>
                <button id="btnMonth" onclick="renderAnalytics('month')" class="px-10 py-4 rounded-2xl font-black text-xs border-2 uppercase bg-white transition-all">Monthly</button>
            </div>
            <div class="grid grid-cols-4 gap-6 text-center font-black uppercase">
                 <div class="bg-slate-900 text-white p-8 rounded-[40px] shadow-2xl italic"><p class="text-[10px] opacity-40">Revenue</p><h3 id="statTotal" class="text-3xl text-orange-500 italic">‚Çπ0</h3></div>
                <div class="bg-white border-2 p-8 rounded-[40px] text-green-600 shadow-sm italic"><p class="text-[10px] text-slate-400">Cash</p><h3 id="statCash" class="text-3xl italic">‚Çπ0</h3></div>
                <div class="bg-white border-2 p-8 rounded-[40px] text-blue-600 shadow-sm italic"><p class="text-[10px] text-slate-400">Digital</p><h3 id="statUPI" class="text-3xl italic">‚Çπ0</h3></div>
                <div class="bg-orange-50 border-2 p-8 rounded-[40px] text-orange-700 shadow-sm italic"><p class="text-[10px] opacity-70">Credit</p><h3 id="statKhaata" class="text-3xl italic">‚Çπ0</h3></div>
            </div>
            <div id="salesLog" class="mt-12 space-y-3 font-bold text-slate-400 italic"></div>
        </div>
    </div>

    <div id="receiptTemplate" class="print-only receipt-container mx-auto">
        <div style="text-align: center; border-bottom: 2px solid #000; padding-bottom: 10px; margin-bottom: 10px;">
            <h1 class="print-brand" style="margin: 0; font-weight: 900;">DEVI SRI MART üïâÔ∏è</h1>
            <p class="telugu print-brand" style="font-size: 16px; margin: 5px 0;">‡∞¶‡±á‡∞µ‡∞ø ‡∞∂‡±ç‡∞∞‡±Ä ‡∞Æ‡∞æ‡∞∞‡±ç‡∞ü‡±ç</p>
            <p style="font-size: 9px; font-weight: bold;">Hardware, paints & Paints | GSTIN: 37ABCDE1234F1Z5</p>
        </div>
        <p style="font-size: 10px;">Date: <span id="rDate"></span></p>
        <table style="width: 100%; border-collapse: collapse; margin-top: 10px; font-size: 11px;">
            <thead style="border-bottom: 1px dashed #000;">
                <tr style="text-align: left;"><th>ITEM</th><th style="text-align: right;">QTY</th><th style="text-align: right;">RATE</th><th style="text-align: right;">TOTAL</th></tr>
            </thead>
            <tbody id="rItems"></tbody>
        </table>
        <div style="border-top: 1px dashed #000; margin-top: 10px; padding-top: 5px; font-size: 12px;">
            <div style="display: flex; justify-content: space-between;"><span>Subtotal:</span><span id="rSub"></span></div>
            <div style="display: flex; justify-content: space-between;"><span>CGST (9%):</span><span id="rCGST"></span></div>
            <div style="display: flex; justify-content: space-between;"><span>SGST (9%):</span><span id="rSGST"></span></div>
            <div style="display: flex; justify-content: space-between; font-weight: bold; font-size: 16px; border-top: 2px solid #000; margin-top: 5px; padding-top: 5px;">
                <span>GRAND TOTAL:</span><span id="rGrand"></span>
            </div>
        </div>
        <div id="rPayInfo" style="margin-top: 15px; font-size: 11px; font-style: italic; border-top: 1px dashed #000; padding-top: 10px;"></div>
        <p style="text-align: center; margin-top: 20px; font-size: 10px; font-weight: bold;">THANK YOU! VISIT AGAIN</p>
    </div>

    <script>
        const ADMIN_PASSWORD = "123";
        let targetModal = "";

        function getMasterData() {
            const data = [
                { category: 'Motors', barcode: 'M101', name_en: 'Kumar Piston Pump 1HP', price: 14500, stock: 10, cgst: 9, sgst: 9 },
                { category: 'Paints', barcode: 'P101', name_en: 'Asian Paints Apex 20L', price: 8450, stock: 50, cgst: 9, sgst: 9 },
                { category: 'Electrical', barcode: 'E101', name_en: 'Modular Switch Box', price: 550, stock: 200, cgst: 9, sgst: 9 },
                { category: 'Sanitary', barcode: 'S101', name_en: 'Hindware Commode', price: 6800, stock: 5, cgst: 9, sgst: 9 },
                { category: 'Hardware', barcode: 'H101', name_en: 'Godrej Door Lock', price: 2400, stock: 20, cgst: 9, sgst: 9 }
            ];
            ['Motors','Paints','Electrical','Sanitary','Hardware'].forEach(cat => {
                for(let i=2; i<=50; i++) {
                    const bc = cat[0]+(100+i);
                    if(!data.find(x=>x.barcode === bc)) data.push({ category: cat, barcode: bc, name_en: `${cat} Premium Item #${i}`, price: 100+(i*10), stock: 50, cgst: 9, sgst: 9 });
                }
            });
            return data;
        }

        let inventory = JSON.parse(localStorage.getItem('DSM_Stock')) || getMasterData();
        let salesHistory = JSON.parse(localStorage.getItem('DSM_Sales')) || [];
        let cart = [];
        let curCat = 'All';
        let payMode = 'Cash';

        function calculateTotal() {
            let sub = 0, cgst = 0, sgst = 0;
            cart.forEach(i => {
                const lineTotal = parseFloat(i.price) * parseFloat(i.qty);
                sub += lineTotal;
                cgst += (lineTotal * (parseFloat(i.cgst) / 100));
                sgst += (lineTotal * (parseFloat(i.sgst) / 100));
            });
            const grand = Math.round(sub + cgst + sgst);
            document.getElementById('cgstDisplay').innerText = "‚Çπ" + cgst.toFixed(2);
            document.getElementById('sgstDisplay').innerText = "‚Çπ" + sgst.toFixed(2);
            document.getElementById('grandTotal').innerText = "‚Çπ" + grand.toLocaleString();
        }

        function renderCatalog() {
            const grid = document.getElementById('productGrid');
            const filtered = curCat === 'All' ? inventory : inventory.filter(p => p.category === curCat);
            grid.innerHTML = filtered.map(p => `<div class="bg-white rounded-[24px] p-5 border shadow-sm flex flex-col justify-between hover:shadow-md h-44"><div><span class="text-[7px] font-bold text-slate-300 uppercase italic">${p.category}</span><h4 class="font-black text-[11px] uppercase italic h-8 overflow-hidden">${p.name_en}</h4><p class="text-xl font-bold italic">‚Çπ${p.price.toLocaleString()}</p></div><button onclick="updateQty('${p.barcode}',1)" class="w-full bg-slate-900 text-white py-2 rounded-lg font-black text-[9px] hover:bg-orange-600 transition">ADD</button></div>`).join('');
        }

        function updateQty(bc, chg) {
            const item = inventory.find(i => i.barcode === bc);
            const idx = cart.findIndex(c => c.barcode === bc);
            if(chg > 0) {
                if(item.stock <= (cart[idx]?.qty || 0)) return alert("STOCK FULL!");
                if(idx > -1) cart[idx].qty += 1; else cart.push({ ...item, qty: 1 });
            } else if(idx > -1) { cart[idx].qty -= 1; if(cart[idx].qty <= 0) cart.splice(idx, 1); }
            updateUI();
        }

        function updateUI() {
            const display = document.getElementById('cartItems');
            if(cart.length === 0) display.innerHTML = `<p class="text-center opacity-10 mt-10 font-black italic">Empty</p>`;
            else display.innerHTML = cart.map((i, index) => `<div class="bg-white p-3 rounded-2xl border shadow-sm"><p class="text-[10px] uppercase font-black mb-2">${i.name_en}</p><div class="flex justify-between items-center bg-slate-50 p-1 rounded-xl"><div class="flex items-center gap-4"><button onclick="updateQty('${i.barcode}',-1)" class="w-8 h-8 bg-white border rounded font-black">-</button><span class="font-bold">${i.qty}</span><button onclick="updateQty('${i.barcode}',1)" class="w-8 h-8 bg-white border rounded font-black">+</button></div><span class="font-bold text-xs italic">‚Çπ${(i.price*i.qty).toLocaleString()}</span></div></div>`).join('');
            calculateTotal();
        }

        function setMode(m) {
            payMode = m;
            document.querySelectorAll('.pay-btn').forEach(b => b.classList.remove('report-active'));
            document.getElementById('m'+m).classList.add('report-active');
            if(m==='Cash') generateSuggestions();
        }

        function generateSuggestions() {
            const total = parseFloat(document.getElementById('grandTotal').innerText.replace(/[‚Çπ,]/g,''));
            const suggs = [ total, Math.ceil(total/10)*10, Math.ceil(total/50)*50, Math.ceil(total/100)*100 ];
            document.getElementById('cashSuggestions').innerHTML = [...new Set(suggs)].filter(v => v >= total).slice(0,4).map(v => `<button onclick="fillCash(${v})" class="bg-white border-2 border-blue-200 text-blue-600 p-2 rounded-xl font-black text-[10px] shadow-sm uppercase italic">‚Çπ${Math.round(v)}</button>`).join('');
        }

        function fillCash(v) { document.getElementById('cashReceived').value = v; updateChange(); }
        function updateChange() {
            const t = parseFloat(document.getElementById('grandTotal').innerText.replace(/[‚Çπ,]/g,''));
            const r = parseFloat(document.getElementById('cashReceived').value) || 0;
            const change = r - t;
            document.getElementById('paymentChangeDisplay').innerText = "‚Çπ" + (change > 0 ? change.toFixed(2) : 0);
        }

        function finalizeSale() {
            const total = parseFloat(document.getElementById('grandTotal').innerText.replace(/[‚Çπ,]/g,''));
            const rcv = parseFloat(document.getElementById('cashReceived').value) || total;
            document.getElementById('rDate').innerText = new Date().toLocaleString();
            document.getElementById('rSub').innerText = "‚Çπ" + (total / 1.18).toFixed(2);
            document.getElementById('rCGST').innerText = document.getElementById('cgstDisplay').innerText;
            document.getElementById('rSGST').innerText = document.getElementById('sgstDisplay').innerText;
            document.getElementById('rGrand').innerText = "‚Çπ" + total.toLocaleString();
            document.getElementById('rItems').innerHTML = cart.map(i => `<tr><td>${i.name_en}</td><td style="text-align:right;">${i.qty}</td><td style="text-align:right;">‚Çπ${i.price}</td><td style="text-align:right;">‚Çπ${(i.price*i.qty).toFixed(2)}</td></tr>`).join('');
            document.getElementById('rPayInfo').innerHTML = `MODE: ${payMode.toUpperCase()} | RECV: ‚Çπ${rcv} | CHG: ‚Çπ${(rcv-total).toFixed(2)}`;
            cart.forEach(c => { const item = inventory.find(i => i.barcode === c.barcode); if(item) item.stock -= c.qty; });
            salesHistory.push({ date: new Date().toISOString(), total, payment: payMode });
            localStorage.setItem('DSM_Sales', JSON.stringify(salesHistory));
            localStorage.setItem('DSM_Stock', JSON.stringify(inventory));
            window.print(); clearCart(); backToSales(); renderCatalog();
        }

        // Utils
        function toggleModal(id) { document.getElementById(id).classList.toggle('hidden'); if(id === 'inventoryPage') updateInventoryTable(); }
        function openSecureArea(a) { targetModal = a; document.getElementById('loginOverlay').classList.remove('hidden'); }
        function checkPassword() { if(document.getElementById('adminPassInput').value === ADMIN_PASSWORD) { document.getElementById('loginOverlay').classList.add('hidden'); toggleModal(targetModal==='inventory'?'inventoryPage':'reportsModal'); if(targetModal==='reports') renderAnalytics('day'); } else alert("Denied"); }
        function closeLogin() { document.getElementById('loginOverlay').classList.add('hidden'); }
        function filterCategory(cat) { curCat = cat; document.querySelectorAll('.sidebar-item').forEach(b => b.classList.remove('active-tab')); document.getElementById('tab-'+cat).classList.add('active-tab'); renderCatalog(); }
        function backToSales() { document.getElementById('paymentPage').classList.add('hidden'); }
        function goToPayment() { if(cart.length === 0) return; document.getElementById('paymentPage').classList.remove('hidden'); setMode('Cash'); document.getElementById('paymentTotalDisplay').innerText = document.getElementById('grandTotal').innerText; document.getElementById('paymentSummaryList').innerHTML = cart.map(i => `<div class="flex justify-between uppercase"><span>${i.name_en} x ${i.qty}</span><b>‚Çπ${(i.price*i.qty).toLocaleString()}</b></div>`).join(''); }
        function clearCart() { cart = []; updateUI(); }
        function liveSearch() { const q = document.getElementById('barcodeScanner').value.toLowerCase(); const grid = document.getElementById('productGrid'); const filtered = inventory.filter(p => p.name_en.toLowerCase().includes(q)); grid.innerHTML = filtered.map(p => `<div class="bg-white rounded-xl p-5 border h-44 flex flex-col justify-between"><div><span class="text-[7px] uppercase text-slate-300 font-black">${p.category}</span><h4 class="font-black text-[10px] uppercase italic mt-1 h-8 overflow-hidden">${p.name_en}</h4><p class="text-xl font-bold italic">‚Çπ${p.price.toLocaleString()}</p></div><button onclick="updateQty('${p.barcode}',1)" class="w-full bg-slate-900 text-white py-2 rounded-lg font-black text-[8px] uppercase">Add</button></div>`).join(''); }
        function openMiscTool() { document.getElementById('miscModal').classList.remove('hidden'); }
        function closeMiscTool() { document.getElementById('miscModal').classList.add('hidden'); }
        function addMiscToCart() { const p = { barcode: 'MISC-'+Date.now(), name_en: document.getElementById('m_name').value || "Unlisted", price: Number(document.getElementById('m_price').value)||0, qty: Number(document.getElementById('m_qty').value)||1, cgst: Number(document.getElementById('m_cgst').value), sgst: Number(document.getElementById('m_sgst').value), category: 'Misc' }; cart.push(p); closeMiscTool(); updateUI(); }
        function updateInventoryTable() { document.getElementById('inventoryTableBody').innerHTML = inventory.map(i => `<tr class="border-b bg-white"><td class="p-6 font-bold uppercase italic">${i.name_en}</td><td class="p-6 text-center font-bold text-orange-600">${i.stock}</td><td class="p-6 text-center">‚Çπ${i.price}</td><td class="p-6 text-center">${i.cgst}%</td><td class="p-6 text-center">${i.sgst}%</td><td class="p-6 text-center"><button onclick="fullModify('${i.barcode}')" class="bg-blue-600 text-white px-6 py-2 rounded-xl text-[10px] uppercase font-black">Modify</button></td></tr>`).join(''); }
        function fullModify(bc) { const i=inventory.find(x => x.barcode === bc); const nN = prompt("Name:", i.name_en); if(!nN) return; const nP = prompt("Price:", i.price); const nS = prompt("Stock:", i.stock); const nC = prompt("CGST:", i.cgst); const nT = prompt("SGST:", i.sgst); if(nN && nP && nS) { i.name_en=nN; i.price=parseFloat(nP); i.stock=parseInt(nS); i.cgst=parseFloat(nC); i.sgst=parseFloat(nT); localStorage.setItem('DSM_Stock',JSON.stringify(inventory)); updateInventoryTable(); renderCatalog(); } }
        function renderAnalytics(range) {
            document.getElementById('reportsModal').classList.remove('hidden');
            const now = new Date(); let filtered = salesHistory;
            ['btnDay', 'btnWeek', 'btnMonth'].forEach(id => document.getElementById(id).classList.remove('report-active'));
            document.getElementById('btn'+range.charAt(0).toUpperCase()+range.slice(1)).classList.add('report-active');
            if(range === 'day') filtered = salesHistory.filter(s => new Date(s.date).toDateString() === now.toDateString());
            else if(range === 'week') filtered = salesHistory.filter(s => (now - new Date(s.date))/(1000*60*60*24) <= 7);
            else if(range === 'month') filtered = salesHistory.filter(s => new Date(s.date).getMonth() === now.getMonth());
            document.getElementById('statTotal').innerText="‚Çπ"+filtered.reduce((s,x)=>s+x.total,0).toLocaleString();
            document.getElementById('statCash').innerText="‚Çπ"+filtered.filter(x=>x.payment==='Cash').reduce((s,x)=>s+x.total,0).toLocaleString();
            document.getElementById('statUPI').innerText="‚Çπ"+filtered.filter(x=>x.payment==='UPI' || x.payment==='Card').reduce((s,x)=>s+x.total,0).toLocaleString();
            document.getElementById('statKhaata').innerText="‚Çπ"+filtered.filter(x=>x.payment==='Khaata').reduce((s,x)=>s+x.total,0).toLocaleString();
            document.getElementById('salesLog').innerHTML = filtered.slice(-10).reverse().map(s => `<div class="flex justify-between bg-gray-50 border p-3 rounded-xl italic font-bold text-xs uppercase"><span>${new Date(s.date).toLocaleString()} [${s.payment}]</span><b>‚Çπ${s.total}</b></div>`).join('');
        }

        window.onload = () => { renderCatalog(); filterCategory('All'); };
    </script>
</body>
</html>
